<?php

declare(strict_types=1);

use function ImpartialPipes\p_filter;
use function ImpartialPipes\p_foreach;
use function ImpartialPipes\p_implode;
use function ImpartialPipes\p_map;
use function ImpartialPipes\p_take_while;

require __DIR__.'/../vendor/autoload.php';

get_defined_functions()['user']
    |> p_filter(fn(string $fqn) => str_starts_with($fqn, 'impartialpipes\\p_'))
    |> p_map(fn(string $fqn) => str_replace('impartialpipes\\', '\\ImpartialPipes\\', $fqn))
    |> p_foreach(function (string $fqn)  {
        $function = new ReflectionFunction($fqn);
        $name = $function->getShortName();

        $doc = explode("\n", $function->getDocComment())
            |> p_map(fn($line) => substr($line, 3))
            |> p_take_while(fn($line) => !str_starts_with($line, '@'))
            |> p_map(function($line)use(&$toggle) {
                if ('```' === $line && ($toggle = !$toggle)) $line = '```php';
                return $line;
            })
            |> p_implode("\n");

        $dir = substr(dirname(realpath($function->getFileName())), strlen(realpath(__DIR__.'/../src')));
        @mkdir(__DIR__.'/../doc/'.$dir, recursive: true);
        file_put_contents(__DIR__."/../doc/$dir/$name.md", <<<MD
            [//]: # (This file is autogenerated)
            
            ## $name
            
            $doc
            MD);
    });
