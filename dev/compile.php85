<?php

declare(strict_types=1);

use function ImpartialPipes\p_filter;
use function ImpartialPipes\p_foreach;
use function ImpartialPipes\p_implode;
use function ImpartialPipes\p_map;
use function ImpartialPipes\p_take_while;

require __DIR__.'/../vendor/autoload.php';

get_defined_functions()['user']
    |> p_filter(fn(string $fqn) => str_starts_with($fqn, 'impartialpipes\\p_'))
    |> p_map(fn(string $fqn) => str_replace('impartialpipes\\', '\\ImpartialPipes\\', $fqn))
    |> p_foreach(function (string $fqn) {
        $function = new ReflectionFunction($fqn);
        $name = $function->getShortName();
        $dir = substr(dirname(realpath($function->getFileName())), strlen(realpath(__DIR__.'/../src')));

        $doc = explode("\n", $function->getDocComment())
            |> p_map(fn($line) => substr($line, 3))
            |> p_take_while(fn($line) => !str_starts_with($line, '@'))
            |> p_map(function($line)use(&$toggle) {
                if ('```' === $line && ($toggle = !$toggle)) $line = '```php';
                return $line;
            })
            |> p_implode("\n");
        @mkdir(__DIR__.'/../doc/'.$dir, recursive: true);
        file_put_contents(__DIR__."/../doc/$dir/$name.md", <<<MD
            [//]: # (This file is autogenerated)
            
            ## $name
            
            $doc
            MD);
    });

new RecursiveIteratorIterator(new RecursiveDirectoryIterator(__DIR__.'/../tst'))
    |> p_filter(static fn(SplFileInfo $file) => $file->isFile() && $file->getExtension() === 'php' && basename($file->getPath()) !== 'tst')
    |> p_foreach(static function (SplFileInfo $file) {
        $dir = substr(realpath($file->getPath()), strlen(realpath(__DIR__.'/../tst')) + 1);

        $content = explode("\n", file_get_contents($file->getPathname()))
            |> function ($line) {
                return $line;
            }
            |> p_implode("\n");

        @mkdir(__DIR__.'/../tst/_php85/'.$dir, recursive: true);
        file_put_contents(__DIR__."/../tst/_php85/$dir/{$file->getBasename()}", $content);
    });